var Nav,hasProp={}.hasOwnProperty;import Build from"../util/Build.js";Nav=class{constructor(s,e,t=null,i=!1){this.tap=this.tap.bind(this),this.dir=this.dir.bind(this),this.stream=s,this.batch=e,this.komps=t,this.isMuse=i,this.navs=this.addInovToNavs(this.komps),this.build=new Build(this.batch),this.$router=null,this.source="None",this.route="Home",this.routeLast="None",this.compKey="Home",this.pracKey="None",this.dispKey="None",this.warnMsg="None",this.inovKey="None",this.presKey="None",this.imgsIdx=0,this.imgsNum=0,this.mix=null,this.pages={},this.keyEvents()}pub(s){var e;this.msgOK(s)&&(e=this.toObj(s),this.doRoute(e.route),console.log("Nav.pub()",e),this.stream.publish("Nav",e))}msgOK(s){var e;return e=!0,this.isMuse&&null!=s.compKey&&!this.hasCompKey(s.compKey)&&(e=!1),e}toObj(s){return this.set(s),null==s.warnMsg&&(this.warnMsg="None"),null==s.source&&(this.source="None"),this.inovKey=this.mix().isDef(s.inovKey)?s.inovKey:this.compKey,{source:this.source,route:this.route,compKey:this.compKey,inovKey:this.inovKey,pracKey:this.pracKey,dispKey:this.dispKey,warnMsg:this.warnMsg,imgsIdx:this.imgsIdx}}set(s){var e,t;for(e in s)hasProp.call(s,e)&&(t=s[e],this[e]=t)}setMix(s){this.mix=s.mix}doRoute(s){s===this.routeLast||this.isInov(s)||(null!=s&&"None"!==s?(this.dirsNavd(s),null!=this.$router?this.$router.push({name:s}):console.error("Nav.doRoute() $router not set"),this.routeLast=this.route,this.route=s):console.error("Nav.doRoute() undefined route"))}hasCompKey(s,e=null){var t;return t=null!=s&&null!=this.navs&&null!=this.navs[s],null!=e&&t?null!=this.navs[s][e]:t}adjCompKey(s,e){return this.hasCompKey(s,e)?this.navs[s][e]:"None"}log(s,e){return s.warnMsg=e,console.log("Nav.log()",this.toObj(s))}tap(){console.log("Nav.tap()")}keyEvents(){var s;s=s=>{switch(s.key){case"ArrowRight":return this.dir("east",s);case"ArrowLeft":return this.dir("west",s);case"ArrowDown":return this.dir("south",s);case"ArrowUp":return this.dir("north",s);case"+":return this.dir("next",s);case"-":return this.dir("prev",s)}},document.addEventListener("keydown",e=>s(e))}dir(s,e=null){if(this.source=s,this.isMuse)switch(this.route){case"Comp":this.dirComp(s);break;case"Prac":this.dirPrac(s);break;case"Disp":this.dirDisp(s);break;case"Talk":this.dirTalk(s);break;default:this.dirComp(s)}else this.dirComp(s,dirs);this.dirsNavd(this.route)}dirComp(s){var e;(e={}).source=`Nav.dirComp(${s})`,this.hasCompKey(this.compKey,s)?(e.compKey=this.adjCompKey(this.compKey,s),e.route=this.toRoute(e.compKey),this.doRoute(e.route),this.pub(e)):this.hasActivePageDir(this.route,s)?this.dirPage(s):this.log(e,{warnMsg:`Missing adjacent component for ${s} ${this.compKey}`})}toRoute(s){return this.isMuse&&this.inArray(s,["Info","Data","Know","Wise"])?"Comp":s}dirPrac(s){var e,t;(t={}).source=`Nav.dirPrac(${s})`,t.compKey=this.compKey,"None"!==(e=this.adjPracObj(s)).name?(e.name!==this.pracKey&&(t.pracKey=e.name),e.plane!==this.compKey&&(t.compKey=e.plane),this.pub(t)):this.log(t,`Missing adjacent practice for ${s} ${this.compKey} ${this.pracKey}`)}dirDisp(s){var e,t,i,r;(r={}).source=`Nav.dirDisp(${s})`,i=this.pracs(this.compKey)[this.pracKey][this.dispKey],e=this.adjPracObj(s),t=i.dir,i=this.getDispObj(e,t),"None"!==e.name?(r.compKey=e.plane,r.pracKey=e.name,r.dispKey=i.name,this.pub(r)):this.log(r,`Missing adjacent displine for ${s} ${this.compKey} ${this.pracKey}`)}dirTalk(s){var e,t,i,r;e=this.dirsNavdTalk(),"None"!==this.pracKey&&e[s]&&((i={}).source=`Nav.dirTalk(${s})`,r=this.mix().sectObject(this.pracKey,this.dispKey),t=this.mix().isArray(r.keys),this.dispKey=r.name,r.imgs||(this.imgsNum=0),this.mix().isDef(this.pageKey)&&this.mix().inArray(this.pageKey,r.keys)||(this.pageKey=r.keys[0]),this.imgsNum>0&&("west"===s||"east"===s)?("west"===s&&(this.imgsIdx=this.prevImg()),"east"===s&&(this.imgsIdx=this.nextImg())):this.isPageTalk(r,t,this.presKey)?this.presKey=function(){switch(s){case"west":case"north":case"prev":return this.prevKey(this.presKey,r.keys);case"east":case"south":return this.nextKey(this.presKey,r.keys);case"next             ":return this.nextPage(this.presKey,r.keys,r.peys);default:return"None"}}.call(this):this.dispKey=function(){switch(s){case"west":return this.prevKey(this.dispKey,r.peys);case"east":return this.nextKey(this.dispKey,r.peys);case"north":return this.presKey="None",this.dispKey;case"south":return this.presKey=r.keys[0],this.dispKey;case"prev":return this.prevKey(this.dispKey,r.peys);case"next":return this.nextDisp(this.dispKey,r.keys,r.peys);default:return"None"}}.call(this),i.dispKey=this.dispKey,i.presKey=this.presKey,i.imgsIdx=this.imgsIdx,this.pub(i))}prevImg(){return this.imgsIdx>0?this.imgsIdx-1:this.imgsNum-1}nextImg(){return this.imgsIdx<this.imgsNum-1?this.imgsIdx+1:0}isPageTalk(s,e,t){return this&&e&&null!=s[t]}dirsNavd(s){var e;e=this.dirsNavdTalk(s),this.stream.publish("Navd",e)}dirsNavdTalk(s){var e,t,i;return e={west:!0,east:!0,north:!0,south:!0,prev:!0,next:!0},"Talk"!==s||"None"===this.pracKey||(i=this.mix().sectObject(this.pracKey,this.dispKey),t=this.mix().isArray(i.keys),this.isPageTalk(i,t,this.presKey)?this.dirsNavdTalkPage(e,i):this.dirsNavdTalkSect(e,i,t)),e}dirsNavdTalkSect(s,e,t){s.west=e.name!==e.peys[0],s.prev=s.west,s.east=e.name!==e.peys[e.peys.length-1],s.next=s.east,s.north=!1,s.south=t}dirsNavdTalkPage(s,e){var t;t=this.mix().presObject(e,this.presKey),s.west=t.name!==e.keys[0],s.prev=s.west,s.east=t.name!==e.keys[e.keys.length-1],s.next=!0,s.north=!0,s.south=!1}prevKey(s,e){var t;return-1===(t=e.indexOf(s)-1)&&(t=e.length-1),e[t]}nextKey(s,e){var t;return(t=e.indexOf(s)+1)===e.length&&(t=0),e[t]}nextPage(s,e,t){return s!==e[e.length-1]?this.nextKey(s,e):(this.dispKey=this.nextKey(this.dispKey,t),"None")}nextDisp(s,e,t){return null!=e[0]?(this.presKey=e[0],s):(this.presKey="None",this.nextKey(s,t))}dirPage(s){var e,t,i;i=this.getPagesComp(this.route,this.compKey),(e={}).source=`Nav.dirPage(${s})`,"None"!==(t=this.hasActivePageDir(this.route,s)?this.movePage(this.pages[i],s):"None")?this.setPageKey(i,t):this.log(e,{warnMsg:"Cannot find pageKey for "+s})}movePage(s,e){var t,i,r,a,h;return h=this.getPagesComp(this.route,this.compKey),a=this.getPageKey(h),i=s.keys.length,"None"!==a?(t=s.keys.indexOf(a),"east"===e&&(r=this.range(t+1,i)),"west"===e&&(r=this.range(t-1,i)),a=s.keys[r]):a="east"===e?s.keys[0]:s.keys[i-1],a}range(s,e){var t;return(t=s)>=e&&(t=0),t<0&&(t=e-1),t}setPages(s,e){this.hasPages(s,!1)||(this.pages[s]={},this.pages[s].pages=e,this.pages[s].keys=Object.keys(e))}setPageKey(s,e){var t,i;if(this.hasPages(s))for(t in i=this.pages[s].pages)hasProp.call(i,t)&&(i[t].show=t===e);else console.log("Nav.setPageKey()",{route:s,pageKey:e,has:this.hasPages(s)})}getPageKey(s,e=!0){var t,i;if(!this.hasPages(s,e))return"None";for(t in i=this.pages[s].pages)if(hasProp.call(i,t)&&i[t].show)return t;return"None"}getPageDef(s){var e;for(e in s)if(hasProp.call(s,e)&&s[e].show)return e;return"None"}hasPages(s,e=!0){var t;return!(t=this.isDef(this.pages[s])&&this.isDef(this.pages[s].pages)&&this.pages[s].keys.length>0)&&e&&console.log("Nav.hasPages()",{route:s,has:t,pages:this.pages}),t}hasPageKey(s,e){return this.isDef(e)&&this.hasPages(s)&&null!=this.pages[s].pages[e]}hasActivePage(s){var e,t;if(!this.hasPages(s))return!1;for(e in t=this.pages[s].pages)if(hasProp.call(t,e)&&t[e].show)return!0;return!1}hasActivePageDir(s,e){return this.hasActivePage(s)&&("west"===e||"east"===e)}isMyNav(s,e){return s.route===e}adjPracObj(s){var e;return e=this.pracs(this.compKey)[this.pracKey],this.build.adjacentPractice(e,s)}getDispObj(s,e){return this.build.getDir(s,e)}pracs(s){return this.batch[s].data.pracs}disps(s,e){return this.batch[s].data.pracs[e].disps}isDef(s){return null!=s&&"None"!==s}isArray(s){return this.isDef(s)&&"string"!=typeof s&&null!=s.length&&s.length>0}inArray(s,e){return this.isArray(e)&&e.indexOf(s)>-1}isInov(s){return this.inArray(s,["Inov","Info","Know","Wise"])}addInovToNavs(s){var e;return this.isMuse?(e=Object.assign({},s),e=this.insInov(e,"Info","Data","Know")):null!=s}insInov(s,e,t,i){return s[e].south=t,s[e].next=t,s[t]={north:e,prev:e,south:i,next:i},s[i].north=t,s[i].prev=t,s}};export default Nav;