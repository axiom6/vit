"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformSFCEntry=void 0;const hash_sum_1=__importDefault(require("hash-sum")),path_1=__importDefault(require("path")),querystring_1=__importDefault(require("querystring")),compiler_sfc_1=require("@vue/compiler-sfc"),descriptorCache_1=require("./utils/descriptorCache"),error_1=require("./utils/error"),script_1=require("./script");function transformSFCEntry(e,t,r,s,o,n,i,c){const{descriptor:p,errors:l}=compiler_sfc_1.parse(e,{sourceMap:!0,filename:t,sourceRoot:s});if(descriptorCache_1.setDescriptor(t,p),l.length)return l.forEach(e=>c.error(error_1.createRollupError(t,e))),null;const u=path_1.default.relative(s,t).replace(/^(\.\.[\/\\])+/,"").replace(/\\/g,"/"),a=hash_sum_1.default(o?u+"\n"+e:u),f=p.styles.some(e=>e.scoped),m=p.scriptSetup&&!(p.template&&p.template.src),d=p.template&&!m,y=d?genTemplateCode(p,a,n):"",_=d?n?"script.ssrRender = ssrRender":"script.render = render":"",g=[genScriptCode(p,a,o,n,r,c),y,genStyleCode(p,a,r.preprocessStyles),getCustomBlock(p,i),_];return f&&g.push("script.__scopeId = "+JSON.stringify("data-v-"+a)),o?r.exposeFilename&&g.push("script.__file = "+JSON.stringify(path_1.default.basename(u))):g.push("script.__file = "+JSON.stringify(u)),g.push("export default script"),{code:g.join("\n"),map:{mappings:""}}}function genTemplateCode(e,t,r){const s=r?"ssrRender":"render";let o,n=`const ${s} = () => {}`;if(e.template){const r=e.template.src||e.filename,i=`?vue&type=template${"&id="+t}${e.template.src?"&src":""}${attrsToQuery(e.template.attrs,"js",!0)}`;o=JSON.stringify(r+i),n=`import { ${s} } from ${o}`}return n}function genScriptCode(e,t,r,s,o,n){let i="const script = {}";const c=script_1.resolveScript(e,t,r,s,o,n);if(c){const t=c.src||e.filename,r=attrsToQuery(c.attrs,"js"),s=`?vue&type=script${c.src?"&src":""}${r}`,o=JSON.stringify(t+s);i=`import script from ${o}\nexport * from `+o}return i}function genStyleCode(e,t,r){let s="",o=!1;return e.styles.length&&e.styles.forEach((n,i)=>{const c=n.src||e.filename,p=attrsToQuery(n.attrs,"css",r),l=p.replace(/&module(=true|=[^&]+)?/,""),u="&id="+t,a=`?vue&type=style&index=${i}${n.src?"&src":""}${u}`,f=c+a+p,m=c+a+l;n.module?(o||(s+="\nconst cssModules = script.__cssModules = {}",o=!0),s+=genCSSModulesCode(i,f,m,n.module)):s+="\nimport "+JSON.stringify(f)}),s}function getCustomBlock(e,t){let r="";return e.customBlocks.forEach((s,o)=>{if(t(s.type)){const t=s.src||e.filename,n=attrsToQuery(s.attrs,s.type),i=s.src?"&src":"",c=`?vue&type=${s.type}&index=${o}${i}${n}`,p=JSON.stringify(t+c);r+=`import block${o} from ${p}\n`,r+=`if (typeof block${o} === 'function') block${o}(script)\n`}}),r}function genCSSModulesCode(e,t,r,s){const o="style"+e;let n="\nimport "+JSON.stringify(r)+`\nimport ${o} from ${JSON.stringify(t+".js")}`;return n+=`\ncssModules["${"string"==typeof s?s:"$style"}"] = ${o}`,n}exports.transformSFCEntry=transformSFCEntry;const ignoreList=["id","index","src","type","lang"];function attrsToQuery(e,t,r=!1){let s="";for(const t in e){const r=e[t];ignoreList.includes(t)||(s+=`&${querystring_1.default.escape(t)}${r?"="+querystring_1.default.escape(String(r)):""}`)}return(t||e.lang)&&(s+="lang"in e?r?"&lang."+t:"&lang."+e.lang:"&lang."+t),s}